<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Brachytherapy QA System - SASQART Compliant</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #d97706;
            --primary-dark: #b45309;
            --secondary: #0369a1;
            --secondary-dark: #075985;
            --success: #059669;
            --success-light: #d1fae5;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --purple: #7c3aed;
            --purple-light: #ede9fe;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 50%, #fde68a 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 32px;
            margin-bottom: 24px;
        }

        h1 {
            color: var(--gray-900);
            margin-bottom: 8px;
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .subtitle {
            color: var(--gray-500);
            font-size: 14px;
            margin-bottom: 24px;
        }

        h2 {
            color: var(--gray-800);
            margin-top: 32px;
            margin-bottom: 16px;
            font-size: 20px;
            font-weight: 600;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h3 {
            color: var(--gray-700);
            margin-top: 20px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        /* Main Navigation Tabs */
        .main-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 0;
            flex-wrap: wrap;
        }

        .main-tab {
            padding: 14px 24px;
            background: var(--gray-100);
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s ease;
            color: var(--gray-600);
            position: relative;
            bottom: -2px;
        }

        .main-tab:hover {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .main-tab.active {
            background: var(--primary);
            color: white;
            border-bottom: 2px solid var(--primary);
        }

        .main-tab-content {
            display: none;
        }

        .main-tab-content.active {
            display: block;
        }

        /* Sub Navigation for QA Types */
        .qa-type-tabs {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .qa-type-tab {
            padding: 10px 20px;
            border: 2px solid var(--gray-300);
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            border-radius: 8px;
            transition: all 0.2s ease;
            color: var(--gray-600);
        }

        .qa-type-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .qa-type-tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .qa-type-tab.daily { border-left: 4px solid var(--success); }
        .qa-type-tab.quarterly { border-left: 4px solid var(--secondary); }
        .qa-type-tab.annual { border-left: 4px solid var(--purple); }

        .qa-type-content {
            display: none;
        }

        .qa-type-content.active {
            display: block;
        }

        /* Info Boxes */
        .info-box {
            background: var(--warning-light);
            border-left: 4px solid var(--warning);
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
        }

        .info-box.success {
            background: var(--success-light);
            border-left-color: var(--success);
        }

        .info-box.secondary {
            background: #e0f2fe;
            border-left-color: var(--secondary);
        }

        .info-box.purple {
            background: var(--purple-light);
            border-left-color: var(--purple);
        }

        .info-box.danger {
            background: #fee2e2;
            border-left-color: var(--danger);
        }

        .info-box.warning {
            background: var(--warning-light);
            border-left-color: var(--warning);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-700);
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group input {
            flex: 1;
        }

        .input-group select {
            width: 100px;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover { background: var(--primary-dark); }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        .btn-secondary:hover { background: var(--secondary-dark); }

        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn-success:hover { background: #047857; }

        .btn-purple {
            background: var(--purple);
            color: white;
        }
        .btn-purple:hover { background: #6d28d9; }

        .btn-gray {
            background: var(--gray-500);
            color: white;
        }
        .btn-gray:hover { background: var(--gray-600); }

        .btn-outline {
            background: white;
            border: 2px solid var(--gray-300);
            color: var(--gray-700);
        }
        .btn-outline:hover { 
            border-color: var(--gray-400);
            background: var(--gray-50);
        }

        button:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        /* QA Tables */
        .qa-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }

        .qa-table th,
        .qa-table td {
            border: 1px solid var(--gray-200);
            padding: 12px 14px;
            text-align: left;
        }

        .qa-table th {
            background: var(--gray-800);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .qa-table th.daily-header { background: var(--success); }
        .qa-table th.quarterly-header { background: var(--secondary); }
        .qa-table th.annual-header { background: var(--purple); }

        .qa-table tr:nth-child(even) {
            background: var(--gray-50);
        }

        .qa-table tr:hover {
            background: var(--warning-light);
        }

        .qa-table .test-id {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--gray-700);
        }

        .status-select {
            padding: 8px 12px;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            width: 100%;
            cursor: pointer;
        }

        .status-pass {
            background: var(--success-light) !important;
        }

        .status-fail {
            background: var(--danger-light) !important;
        }

        .status-na {
            background: var(--gray-100) !important;
        }

        .measurement-input {
            padding: 8px 12px;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            width: 100%;
        }

        .tolerance-cell {
            font-size: 13px;
            color: var(--gray-600);
        }

        .tolerance-cell strong {
            color: var(--gray-800);
        }

        /* Result Boxes */
        .result-box {
            background: linear-gradient(135deg, var(--primary) 0%, var(--danger) 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
        }

        .result-box.show {
            display: block;
        }

        .result-value {
            font-size: 42px;
            font-weight: 700;
            margin: 12px 0;
            font-family: 'JetBrains Mono', monospace;
        }

        .comparison-box {
            background: #dbeafe;
            border: 2px solid var(--secondary);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
        }

        .comparison-box.show {
            display: block;
        }

        .difference {
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary-dark);
            margin-top: 12px;
        }

        /* Timer */
        .timer-box {
            background: var(--gray-100);
            border: 2px solid var(--gray-300);
            padding: 24px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .timer-display {
            font-size: 56px;
            font-weight: 700;
            text-align: center;
            color: var(--gray-800);
            margin: 20px 0;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 2px;
        }

        .timer-buttons {
            display: flex;
            gap: 12px;
            margin: 16px 0;
            justify-content: center;
        }

        .timer-list {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .timer-item {
            background: white;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timer-item button {
            padding: 6px 12px;
            font-size: 12px;
            background: var(--danger);
        }

        /* Header Section */
        .header-section {
            background: var(--gray-50);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 24px;
            border: 1px solid var(--gray-200);
        }

        .header-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        /* Signature Section */
        .signature-section {
            margin-top: 32px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        .signature-box {
            border-top: 2px solid var(--gray-800);
            padding-top: 12px;
        }

        /* DB Status */
        .db-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .db-status.connected {
            background: var(--success-light);
            color: var(--success);
        }

        .db-status.error {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* Graph */
        .graph-container {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid var(--gray-200);
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-top: 16px;
        }

        /* Explanation Box */
        .explanation {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-left: 4px solid var(--success);
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 12px 12px 0;
        }

        .explanation ul {
            margin-left: 20px;
            margin-top: 12px;
        }

        .explanation li {
            margin-bottom: 8px;
        }

        /* Notes */
        .note {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
            font-size: 13px;
            color: var(--gray-500);
        }

        /* Frequency Badge */
        .frequency-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .frequency-badge.daily { background: var(--success-light); color: var(--success); }
        .frequency-badge.quarterly { background: #e0f2fe; color: var(--secondary); }
        .frequency-badge.annual { background: var(--purple-light); color: var(--purple); }

        /* Section Divider */
        .section-divider {
            display: flex;
            align-items: center;
            margin: 32px 0 24px;
            gap: 16px;
        }

        .section-divider::before,
        .section-divider::after {
            content: '';
            flex: 1;
            height: 2px;
            background: var(--gray-200);
        }

        .section-divider span {
            font-weight: 700;
            color: var(--gray-600);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Print Styles */
        @media print {
            @page {
                size: A4 portrait;
                margin: 15mm 12mm 15mm 12mm;
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body {
                background: white;
                padding: 0;
                margin: 0;
                font-size: 10pt;
                line-height: 1.3;
            }

            .container {
                box-shadow: none;
                max-width: 100%;
                padding: 0;
                margin: 0;
            }

            /* Hide navigation and non-essential elements */
            .main-tabs, .qa-type-tabs, .btn-primary, .btn-secondary, .btn-purple, 
            .btn-gray, .no-print, .graph-container, .timer-box, .comparison-box,
            #history, #decay, .inline-calc, #sourceChangeInfo,
            .container > h1, .container > .subtitle {
                display: none !important;
            }

            /* Show QA content */
            #qa {
                display: block !important;
            }

            /* Only show active QA type for printing */
            .qa-type-content {
                display: none !important;
            }
            .qa-type-content.print-active {
                display: block !important;
            }

            /* Print header */
            .print-header {
                display: block !important;
                border-bottom: 2px solid #1e3a5f;
                padding-bottom: 10px;
                margin-bottom: 15px;
            }

            .print-header h1 {
                font-size: 16pt;
                margin: 0 0 5px 0;
                color: #1e3a5f;
            }

            .print-header .print-meta {
                display: flex;
                justify-content: space-between;
                font-size: 9pt;
                color: #444;
            }

            /* QA Table styling for print */
            .qa-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 9pt;
                page-break-inside: auto;
            }

            .qa-table thead {
                display: table-header-group;
            }

            .qa-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            .qa-table th {
                background-color: #1e3a5f !important;
                color: white !important;
                padding: 6px 4px;
                text-align: left;
                font-weight: 600;
                font-size: 8pt;
            }

            .qa-table td {
                padding: 5px 4px;
                border-bottom: 1px solid #ddd;
                vertical-align: top;
            }

            .qa-table .test-id {
                font-weight: 600;
                width: 50px;
            }

            .qa-table .tolerance-cell {
                font-size: 8pt;
                width: 80px;
            }

            /* Status indicators for print */
            .status-select {
                border: none;
                background: transparent;
                font-size: 9pt;
                padding: 0;
                -webkit-appearance: none;
                appearance: none;
            }

            .measurement-input {
                border: none;
                background: transparent;
                font-size: 9pt;
                padding: 0;
                width: 100%;
            }

            /* Info boxes */
            .info-box {
                padding: 8px 10px;
                margin: 10px 0;
                font-size: 9pt;
                border-left-width: 3px;
            }

            /* Form sections */
            .form-group {
                margin-bottom: 8px;
            }

            .form-group label {
                font-size: 8pt;
                font-weight: 600;
            }

            .header-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                margin-bottom: 15px;
            }

            .header-grid input, .header-grid select {
                border: 1px solid #ccc;
                padding: 4px;
                font-size: 9pt;
            }

            /* Signature section */
            .signature-section {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
                margin-top: 20px;
                padding-top: 15px;
                border-top: 1px solid #ddd;
            }

            .signature-section .form-group {
                text-align: center;
            }

            .signature-section input {
                border: none;
                border-bottom: 1px solid #333;
                text-align: center;
                padding: 4px;
                font-size: 9pt;
            }

            /* Comments */
            #qaComments {
                border: 1px solid #ccc;
                padding: 8px;
                font-size: 9pt;
                min-height: 50px;
                width: 100%;
            }

            /* Page breaks */
            h2 {
                page-break-after: avoid;
                font-size: 12pt;
                margin-top: 15px;
            }

            .note {
                font-size: 8pt;
                color: #666;
                margin-top: 10px;
                padding: 8px;
                background: #f9f9f9;
            }

            /* Hide small helper text on print */
            small {
                display: none;
            }

            /* Print footer */
            .print-footer {
                display: block !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                text-align: center;
                font-size: 8pt;
                color: #666;
                padding: 5px;
                border-top: 1px solid #ddd;
            }
        }

        /* Hide print-only elements on screen */
        .print-header, .print-footer {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .main-tabs {
                flex-direction: column;
            }

            .main-tab {
                border-radius: 8px;
            }

            .header-grid {
                grid-template-columns: 1fr;
            }

            .signature-section {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            ‚öõÔ∏è Brachytherapy QA System
            <span id="dbStatus" class="db-status">Initializing...</span>
        </h1>
        <p class="subtitle">Complete SASQART-Compliant Quality Assurance for HDR/PDR/LDR Remote Afterloaders</p>
        
        <!-- Print Header (only visible when printing) -->
        <div class="print-header">
            <h1>Brachytherapy QA Report</h1>
            <div class="print-meta">
                <span id="printReportType">Daily QA Checklist</span>
                <span id="printDate"></span>
                <span>SASQART Compliant</span>
            </div>
        </div>

        <!-- Print Footer -->
        <div class="print-footer">
            SASQART: South African Standards for Quality Assurance in Radiotherapy (2025) | Generated by Brachytherapy QA System
        </div>
        
        <div class="main-tabs no-print">
            <button class="main-tab active" onclick="switchMainTab('decay')">üìä Ir-192 Calculator</button>
            <button class="main-tab" onclick="switchMainTab('qa')">üìã QA Checklists</button>
            <button class="main-tab" onclick="switchMainTab('history')">üìÅ History & Reports</button>
        </div>

        <!-- IR-192 DECAY CALCULATOR TAB -->
        <div id="decay" class="main-tab-content active">
            <div class="explanation">
                <h3>üìñ Ir-192 Decay Calculator with Database Storage</h3>
                <p>This calculator uses <strong>IndexedDB</strong> for persistent local storage of all your QA data.</p>
                <ul>
                    <li><strong>Real-time Decay:</strong> Automatic calculation based on 73.83-day half-life</li>
                    <li><strong>Visual Graph:</strong> See decay curve from calibration to 365 days</li>
                    <li><strong>System Comparison:</strong> Compare with your treatment planning system values</li>
                    <li><strong>Treatment Timers:</strong> Track and save treatment times with notes</li>
                </ul>
            </div>

            <div class="info-box">
                <strong>Ir-192 Half-life:</strong> 73.83 days | <strong>Decay Constant (Œª):</strong> 0.009389 day‚Åª¬π | <strong>Status:</strong> <span id="saveStatus">Ready</span>
            </div>

            <div class="form-group">
                <label>Initial Activity at Calibration</label>
                <div class="input-group">
                    <input type="number" id="initialActivity" step="0.001" placeholder="Enter initial activity">
                    <select id="unit" onchange="updateMinActivityUnit(); calculateDecay()">
                        <option value="Ci">Ci</option>
                        <option value="mCi">mCi</option>
                        <option value="GBq">GBq</option>
                        <option value="TBq">TBq</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>üìÖ Calibration Date</label>
                <input type="date" id="calibrationDate">
            </div>

            <div class="form-group">
                <label>‚ö†Ô∏è Minimum Usable Activity (Source Change Threshold)</label>
                <div class="input-group">
                    <input type="number" id="minActivity" step="0.001" placeholder="e.g., 3.0" oninput="calculateDecay()">
                    <span style="padding: 12px; background: var(--gray-100); border-radius: 0 8px 8px 0; color: var(--gray-600);" id="minActivityUnit">Ci</span>
                </div>
                <small style="color: var(--gray-500);">Activity below which source should be replaced (typically 25-30% of initial)</small>
            </div>

            <div class="result-box" id="resultBox">
                <h3 style="color: white; margin: 0;">Current Activity</h3>
                <div class="result-value" id="currentActivity">0.000 Ci</div>
                <div style="opacity: 0.9; font-size: 14px;">
                    <div id="percentRemaining">0% of initial activity</div>
                    <div id="daysElapsed">Days elapsed: 0</div>
                </div>
            </div>

            <div class="button-group no-print">
                <button class="btn-success" onclick="saveData()">üíæ Save to Database</button>
                <button class="btn-secondary" id="recalibrateBtn" onclick="recalibrate()" disabled>üîÑ Recalibrate</button>
                <button class="btn-gray" onclick="resetAll()">Reset All</button>
            </div>

            <!-- DECAY GRAPH -->
            <div class="graph-container" id="graphContainer" style="display: none;">
                <h3>üìä Ir-192 Decay Curve</h3>
                <p style="color: var(--gray-500); font-size: 14px;">
                    Showing activity decay from calibration date to 365 days
                </p>
                <div class="chart-wrapper">
                    <canvas id="decayChart"></canvas>
                </div>
            </div>

            <h2>üîç Compare with Brachy System</h2>
            <div class="form-group">
                <label>Treatment Planning System Activity Value</label>
                <div class="input-group">
                    <input type="number" id="brachyValue" step="0.001" placeholder="Enter TPS value">
                    <button class="btn-purple" onclick="compareValues()" style="width: 150px;">Compare</button>
                </div>
            </div>

            <div class="comparison-box" id="comparisonBox">
                <h3 style="margin-top: 0;">Comparison Results</h3>
                <div><strong>Calculator:</strong> <span id="calcValue">0</span></div>
                <div><strong>TPS Value:</strong> <span id="brachyValueDisplay">0</span></div>
                <div class="difference">Difference: <span id="diffPercent">0</span>%</div>
                <small style="margin-top: 12px; display: block; color: var(--gray-600);">
                    ‚úì Difference ‚â§ 2% is typically acceptable for QA | ‚ö†Ô∏è > 3% requires investigation
                </small>
            </div>

            <h2>‚è±Ô∏è Treatment Timers</h2>
            <div class="timer-box">
                <div class="timer-display" id="timerDisplay">00:00:00</div>
                <div class="timer-buttons">
                    <button class="btn-success" onclick="startTimer()">‚ñ∂Ô∏è Start</button>
                    <button class="btn-gray" onclick="stopTimer()">‚è∏Ô∏è Stop</button>
                    <button class="btn-secondary" onclick="resetTimer()">üîÑ Reset</button>
                </div>
                <div class="form-group">
                    <label>Timer Note (Optional)</label>
                    <input type="text" id="timerNote" placeholder="e.g., Patient ID, Treatment site">
                </div>
                <button class="btn-success" onclick="saveTimer()" style="width: 100%;">üíæ Save Timer</button>
                
                <div class="timer-list" id="timerList"></div>
            </div>
        </div>

        <!-- QA CHECKLISTS TAB -->
        <div id="qa" class="main-tab-content">
            <div class="explanation">
                <h3>üìã Complete Brachytherapy QA Checklists</h3>
                <p>Based on <strong>SASQART Table 18</strong>: Quality assurance tests for HDR, PDR, and LDR remote afterloaders</p>
                <p><strong>Reference:</strong> South African Standards for Quality Assurance in Radiotherapy (SASQART) 2025</p>
            </div>

            <div class="qa-type-tabs no-print">
                <button class="qa-type-tab daily active" onclick="switchQAType('daily')">
                    üåÖ Daily Tests (DBR1-12)
                </button>
                <button class="qa-type-tab quarterly" onclick="switchQAType('quarterly')">
                    üìÜ Quarterly Tests (QBR1-8)
                </button>
                <button class="qa-type-tab annual" onclick="switchQAType('annual')">
                    üìÖ Annual Tests (ABR1-5)
                </button>
            </div>

            <!-- Report Header -->
            <div class="header-section">
                <h3 style="margin-top: 0;">Report Information</h3>
                <div class="header-grid">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="qaDate">
                    </div>
                    <div class="form-group">
                        <label>Performed By</label>
                        <input type="text" id="qaPerformer" placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label>Unit/Device</label>
                        <input type="text" id="qaUnit" placeholder="e.g., HDR Flexitron">
                    </div>
                    <div class="form-group">
                        <label>Current Source Activity</label>
                        <input type="text" id="qaSourceActivity" placeholder="Activity value">
                    </div>
                </div>
            </div>

            <!-- DAILY QA TESTS -->
            <div id="daily-qa" class="qa-type-content active">
                <div class="info-box success">
                    <strong>Daily Tests (DBR1-DBR12)</strong> - Perform once during every treatment day, separated by at least 12 hours.
                    These tests verify safety interlocks and basic functionality before patient treatments.
                </div>

                <table class="qa-table" id="dailyQATable">
                    <thead>
                        <tr>
                            <th class="daily-header" style="width: 80px;">Test #</th>
                            <th class="daily-header">Test Description</th>
                            <th class="daily-header" style="width: 140px;">Tolerance / Action</th>
                            <th class="daily-header" style="width: 100px;">Status</th>
                            <th class="daily-header" style="width: 180px;">Measurement/Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="qa-row">
                            <td class="test-id">DBR1</td>
                            <td>Door interlock/last person out<br><small style="color: var(--gray-500);">Verify radiation cannot be initiated with door open</small></td>
                            <td class="tolerance-cell"><strong>Functional</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Notes"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">DBR2</td>
                            <td>Treatment interrupt<br><small style="color: var(--gray-500);">Verify treatment can be paused and resumed correctly</small></td>
                            <td class="tolerance-cell"><strong>Functional</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Notes"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">DBR3</td>
                            <td>Emergency off (console)<br><small style="color: var(--gray-500);">Test console emergency stop button functionality</small></td>
                            <td class="tolerance-cell"><strong>Functional</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Notes"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">DBR4</td>
                            <td>Room radiation monitor(s)<br><small style="color: var(--gray-500);">Verify area monitors respond to radiation</small></td>
                            <td class="tolerance-cell"><strong>Functional</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Notes"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">DBR5</td>
                            <td>Room radiation warning lights<br><small style="color: var(--gray-500);">Verify warning lights illuminate during treatment</small></td>
                            <td class="tolerance-cell"><strong>Functional</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Notes"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">DBR6</td>
                            <td>Console displays<br><small style="color: var(--gray-500);">Verify treatment status indicator, correct date, time, source strength</small>
                                <div class="inline-calc" style="margin-top: 8px; padding: 10px; background: var(--gray-50); border-radius: 6px;">
                                    <div style="font-size: 12px; margin-bottom: 6px;"><strong>Quick Source Strength Check:</strong></div>
                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                        <input type="number" step="0.01" id="dbr6_initial" placeholder="Initial (Ci)" style="width: 85px; padding: 6px;" oninput="calcQuickDecay()">
                                        <input type="date" id="dbr6_caldate" style="padding: 6px;" oninput="calcQuickDecay()">
                                        <span>‚Üí Today:</span>
                                        <strong id="dbr6_expected" style="color: var(--primary);">-- Ci</strong>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 6px;">
                                        <span>Console shows:</span>
                                        <input type="number" step="0.01" id="dbr6_console" placeholder="Console (Ci)" style="width: 85px; padding: 6px;" oninput="calcQuickDecay()">
                                        <span>Diff:</span>
                                        <strong id="dbr6_diff" style="color: var(--secondary);">--%</strong>
                                    </div>
                                </div>
                            </td>
                            <td class="tolerance-cell"><strong>Verify</strong></td>
                            <td>
                                <select class="status-select" id="dbr6_status" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" id="dbr6_notes" placeholder="Auto-filled"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">DBR7</td>
                            <td>Printer operation, Paper supply<br><small style="color: var(--gray-500);">If printer is used for treatment records</small></td>
                            <td class="tolerance-cell"><strong>Functional</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Notes"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">DBR8</td>
                            <td>Data transfer from Planning Computer<br><small style="color: var(--gray-500);">Verify TPS to afterloader communication</small></td>
                            <td class="tolerance-cell"><strong>Functional</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Notes"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">DBR9</td>
                            <td>Audio/Visual communication system<br><small style="color: var(--gray-500);">Test intercom and camera systems</small></td>
                            <td class="tolerance-cell"><strong>Functional</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Notes"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">DBR10</td>
                            <td>Source positional accuracy<br><small style="color: var(--gray-500);">Verify using autoradiographs, ion chamber, or camera</small>
                                <div class="inline-calc" style="margin-top: 8px; padding: 10px; background: var(--gray-50); border-radius: 6px;">
                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                        <input type="number" id="dbr10_expected" placeholder="Expected (mm)" style="width: 100px; padding: 6px;" oninput="calcPositional('dbr10')">
                                        <span>vs</span>
                                        <input type="number" id="dbr10_measured" placeholder="Measured (mm)" style="width: 100px; padding: 6px;" oninput="calcPositional('dbr10')">
                                        <span>= Deviation:</span>
                                        <strong id="dbr10_result" style="color: var(--secondary);">-- mm</strong>
                                    </div>
                                </div>
                            </td>
                            <td class="tolerance-cell"><strong>Tol:</strong> 1 mm<br><strong>Act:</strong> 2 mm</td>
                            <td>
                                <select class="status-select" id="dbr10_status" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" id="dbr10_notes" placeholder="Auto-filled"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">DBR11</td>
                            <td>Dwell time accuracy<br><small style="color: var(--gray-500);">Compare with stopwatch (use sufficiently long dwell time)</small>
                                <div class="inline-calc" style="margin-top: 8px; padding: 10px; background: var(--gray-50); border-radius: 6px;">
                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                        <input type="number" id="dbr11_set" placeholder="Set (s)" style="width: 80px; padding: 6px;" oninput="calcDwellTime('dbr11')">
                                        <span>vs</span>
                                        <input type="number" id="dbr11_measured" placeholder="Measured (s)" style="width: 80px; padding: 6px;" oninput="calcDwellTime('dbr11')">
                                        <span>=</span>
                                        <strong id="dbr11_result" style="color: var(--secondary);">--%</strong>
                                    </div>
                                </div>
                            </td>
                            <td class="tolerance-cell"><strong>Tol:</strong> 1%<br><strong>Act:</strong> 2%</td>
                            <td>
                                <select class="status-select" id="dbr11_status" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" id="dbr11_notes" placeholder="Auto-filled"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">DBR12*</td>
                            <td>PDR Sequencing<br><small style="color: var(--gray-500);">*Test required for PDR units only</small></td>
                            <td class="tolerance-cell"><strong>Functional</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Notes"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- QUARTERLY QA TESTS -->
            <div id="quarterly-qa" class="qa-type-content">
                <div class="info-box secondary">
                    <strong>Quarterly Tests (QBR1-QBR8)</strong> - Perform every 3 months OR at source replacement.
                    These tests verify source calibration, equipment integrity, and timer accuracy.
                </div>

                <table class="qa-table" id="quarterlyQATable">
                    <thead>
                        <tr>
                            <th class="quarterly-header" style="width: 80px;">Test #</th>
                            <th class="quarterly-header">Test Description</th>
                            <th class="quarterly-header" style="width: 140px;">Tolerance / Action</th>
                            <th class="quarterly-header" style="width: 100px;">Status</th>
                            <th class="quarterly-header" style="width: 180px;">Measurement/Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="qa-row">
                            <td class="test-id">QBR1</td>
                            <td>Mechanical integrity of applicators, guide tubes, connectors<br><small style="color: var(--gray-500);">Check for excessive wear, kinks, damage</small></td>
                            <td class="tolerance-cell"><strong>Functional</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Items checked"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">QBR2</td>
                            <td>Emergency off (in room)<br><small style="color: var(--gray-500);">Test in-room emergency buttons - can test without exposing source</small></td>
                            <td class="tolerance-cell"><strong>Functional</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Buttons tested"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">QBR3</td>
                            <td>Power failure recovery<br><small style="color: var(--gray-500);">Verify equipment safely terminates and resumes after power failure</small></td>
                            <td class="tolerance-cell"><strong>Functional</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Notes"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">QBR4</td>
                            <td>Source strength calibration<br><small style="color: var(--gray-500);">Compare measured vs manufacturer value using SSDL-calibrated chamber</small>
                                <div class="inline-calc" style="margin-top: 8px; padding: 10px; background: var(--gray-50); border-radius: 6px;">
                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                        <input type="number" id="qbr4_cert" placeholder="Certificate" style="width: 90px; padding: 6px;" oninput="calcSourceStrength('qbr4')">
                                        <span>vs</span>
                                        <input type="number" id="qbr4_measured" placeholder="Measured" style="width: 90px; padding: 6px;" oninput="calcSourceStrength('qbr4')">
                                        <span>= Diff:</span>
                                        <strong id="qbr4_result" style="color: var(--secondary);">--%</strong>
                                    </div>
                                </div>
                            </td>
                            <td class="tolerance-cell"><strong>Tol:</strong> 3%<br><strong>Act:</strong> 5%</td>
                            <td>
                                <select class="status-select" id="qbr4_status" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" id="qbr4_notes" placeholder="Auto-filled"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">QBR5</td>
                            <td>Source positional accuracy<br><small style="color: var(--gray-500);">Deviation should be 0 mm at source replacement</small>
                                <div class="inline-calc" style="margin-top: 8px; padding: 10px; background: var(--gray-50); border-radius: 6px;">
                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                        <input type="number" id="qbr5_expected" placeholder="Expected (mm)" style="width: 100px; padding: 6px;" oninput="calcPositional('qbr5')">
                                        <span>vs</span>
                                        <input type="number" id="qbr5_measured" placeholder="Measured (mm)" style="width: 100px; padding: 6px;" oninput="calcPositional('qbr5')">
                                        <span>= Deviation:</span>
                                        <strong id="qbr5_result" style="color: var(--secondary);">-- mm</strong>
                                    </div>
                                </div>
                            </td>
                            <td class="tolerance-cell"><strong>Tol:</strong> 1 mm<br><strong>Act:</strong> 2 mm</td>
                            <td>
                                <select class="status-select" id="qbr5_status" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" id="qbr5_notes" placeholder="Auto-filled"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">QBR6</td>
                            <td>Dwell time accuracy<br><small style="color: var(--gray-500);">Compare with stopwatch over clinically relevant times</small>
                                <div class="inline-calc" style="margin-top: 8px; padding: 10px; background: var(--gray-50); border-radius: 6px;">
                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                        <input type="number" id="qbr6_set" placeholder="Set (s)" style="width: 80px; padding: 6px;" oninput="calcDwellTime('qbr6')">
                                        <span>vs</span>
                                        <input type="number" id="qbr6_measured" placeholder="Measured (s)" style="width: 80px; padding: 6px;" oninput="calcDwellTime('qbr6')">
                                        <span>=</span>
                                        <strong id="qbr6_result" style="color: var(--secondary);">--%</strong>
                                    </div>
                                </div>
                            </td>
                            <td class="tolerance-cell"><strong>Tol:</strong> 1%<br><strong>Act:</strong> 2%</td>
                            <td>
                                <select class="status-select" id="qbr6_status" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" id="qbr6_notes" placeholder="Auto-filled"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">QBR7</td>
                            <td>Timer linearity<br><small style="color: var(--gray-500);">Verify linearity over clinically relevant range</small>
                                <div class="inline-calc" style="margin-top: 8px; padding: 10px; background: var(--gray-50); border-radius: 6px;">
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; font-size: 12px; margin-bottom: 8px;">
                                        <div><strong>Set (s)</strong></div>
                                        <div><strong>Measured (s)</strong></div>
                                        <div><strong>Set (s)</strong></div>
                                        <div><strong>Measured (s)</strong></div>
                                        <input type="number" id="qbr7_s1" placeholder="10" style="padding: 4px;" oninput="calcLinearity()">
                                        <input type="number" id="qbr7_m1" placeholder="--" style="padding: 4px;" oninput="calcLinearity()">
                                        <input type="number" id="qbr7_s2" placeholder="30" style="padding: 4px;" oninput="calcLinearity()">
                                        <input type="number" id="qbr7_m2" placeholder="--" style="padding: 4px;" oninput="calcLinearity()">
                                        <input type="number" id="qbr7_s3" placeholder="60" style="padding: 4px;" oninput="calcLinearity()">
                                        <input type="number" id="qbr7_m3" placeholder="--" style="padding: 4px;" oninput="calcLinearity()">
                                        <input type="number" id="qbr7_s4" placeholder="120" style="padding: 4px;" oninput="calcLinearity()">
                                        <input type="number" id="qbr7_m4" placeholder="--" style="padding: 4px;" oninput="calcLinearity()">
                                    </div>
                                    <div>Max deviation: <strong id="qbr7_result" style="color: var(--secondary);">--%</strong></div>
                                </div>
                            </td>
                            <td class="tolerance-cell"><strong>Tol:</strong> 1%<br><strong>Act:</strong> 2%</td>
                            <td>
                                <select class="status-select" id="qbr7_status" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" id="qbr7_notes" placeholder="Auto-filled"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">QBR8</td>
                            <td>Records<br><small style="color: var(--gray-500);">QC checks, maintenance, service calls complete and legible</small></td>
                            <td class="tolerance-cell"><strong>Complete</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Notes"></td>
                        </tr>
                    </tbody>
                </table>

                <div class="form-group">
                    <label>Source Replacement Details (if applicable)</label>
                    <div class="header-grid">
                        <div class="form-group">
                            <label>New Source Serial #</label>
                            <input type="text" id="newSourceSerial" placeholder="Source serial number">
                        </div>
                        <div class="form-group">
                            <label>Certificate Activity</label>
                            <input type="number" step="0.001" id="certificateActivity" placeholder="Cert activity" oninput="calcSourceReplacement()">
                        </div>
                        <div class="form-group">
                            <label>Measured Activity</label>
                            <input type="number" step="0.001" id="measuredActivity" placeholder="Measured activity" oninput="calcSourceReplacement()">
                        </div>
                        <div class="form-group">
                            <label>Chamber Serial #</label>
                            <input type="text" id="chamberSerial" placeholder="Re-entrant chamber ID">
                        </div>
                    </div>
                    <div class="inline-calc" style="margin-top: 10px; padding: 12px; background: var(--gray-50); border-radius: 6px;">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <span><strong>Certificate vs Measured:</strong></span>
                            <span>Difference: <strong id="srcRepl_diff" style="color: var(--secondary); font-size: 16px;">--%</strong></span>
                            <span style="color: var(--gray-500); font-size: 12px;">(Tol: 3%, Action: 5%)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANNUAL QA TESTS -->
            <div id="annual-qa" class="qa-type-content">
                <div class="info-box purple">
                    <strong>Annual Tests (ABR1-ABR5)</strong> - Perform once every 12 months (intervals between 10-14 months).
                    These tests ensure comprehensive review and independent verification.
                </div>

                <table class="qa-table" id="annualQATable">
                    <thead>
                        <tr>
                            <th class="annual-header" style="width: 80px;">Test #</th>
                            <th class="annual-header">Test Description</th>
                            <th class="annual-header" style="width: 140px;">Tolerance / Action</th>
                            <th class="annual-header" style="width: 100px;">Status</th>
                            <th class="annual-header" style="width: 180px;">Measurement/Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="qa-row">
                            <td class="test-id">ABR1</td>
                            <td>Transit dose reproducibility<br><small style="color: var(--gray-500);">Verify transit dose or source speed between dwell positions using autoradiographs, ion chamber, or camera</small>
                                <div class="inline-calc" style="margin-top: 8px; padding: 10px; background: var(--gray-50); border-radius: 6px;">
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 12px; margin-bottom: 8px;">
                                        <input type="number" id="abr1_r1" placeholder="Reading 1" style="padding: 4px;" oninput="calcTransitDose()">
                                        <input type="number" id="abr1_r2" placeholder="Reading 2" style="padding: 4px;" oninput="calcTransitDose()">
                                        <input type="number" id="abr1_r3" placeholder="Reading 3" style="padding: 4px;" oninput="calcTransitDose()">
                                    </div>
                                    <div>Mean: <span id="abr1_mean">--</span> | Max variation: <strong id="abr1_result" style="color: var(--secondary);">--%</strong></div>
                                </div>
                            </td>
                            <td class="tolerance-cell"><strong>Tol:</strong> 1%<br><strong>Act:</strong> 2%</td>
                            <td>
                                <select class="status-select" id="abr1_status" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" id="abr1_notes" placeholder="Auto-filled"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">ABR2</td>
                            <td>X-ray marker positional accuracy<br><small style="color: var(--gray-500);">Autoradiograph of source positions vs radiograph of applicator with x-ray markers. Check for each applicator type.</small>
                                <div class="inline-calc" style="margin-top: 8px; padding: 10px; background: var(--gray-50); border-radius: 6px;">
                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                        <input type="number" id="abr2_expected" placeholder="Marker pos (mm)" style="width: 110px; padding: 6px;" oninput="calcPositional('abr2')">
                                        <span>vs</span>
                                        <input type="number" id="abr2_measured" placeholder="Source pos (mm)" style="width: 110px; padding: 6px;" oninput="calcPositional('abr2')">
                                        <span>= Deviation:</span>
                                        <strong id="abr2_result" style="color: var(--secondary);">-- mm</strong>
                                    </div>
                                </div>
                            </td>
                            <td class="tolerance-cell"><strong>Tol:</strong> 1 mm<br><strong>Act:</strong> 2 mm</td>
                            <td>
                                <select class="status-select" id="abr2_status" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" id="abr2_notes" placeholder="Auto-filled"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">ABR3</td>
                            <td>Review emergency response procedures<br><small style="color: var(--gray-500);">Review procedures for source fails to retract / exposed in room scenarios</small></td>
                            <td class="tolerance-cell"><strong>Complete</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Date reviewed"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">ABR4</td>
                            <td>Independent quality control review<br><small style="color: var(--gray-500);">Second qualified medical physicist verifies implementation, analysis & interpretation of QC tests</small></td>
                            <td class="tolerance-cell"><strong>Complete</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Reviewer name"></td>
                        </tr>
                        <tr class="qa-row">
                            <td class="test-id">ABR5</td>
                            <td>Radiation survey around afterloader (source retracted)<br><small style="color: var(--gray-500);">Ensure source is fully retracted and check for leakage</small></td>
                            <td class="tolerance-cell"><strong>Complete</strong></td>
                            <td>
                                <select class="status-select" onchange="updateRowColor(this)">
                                    <option value="">-</option>
                                    <option value="pass">‚úì Pass</option>
                                    <option value="fail">‚úó Fail</option>
                                    <option value="na">N/A</option>
                                </select>
                            </td>
                            <td><input type="text" class="measurement-input" placeholder="Max reading (¬µSv/h)"></td>
                        </tr>
                    </tbody>
                </table>

                <div class="form-group">
                    <label>Annual Review Details</label>
                    <div class="header-grid">
                        <div class="form-group">
                            <label>Independent Reviewer</label>
                            <input type="text" id="independentReviewer" placeholder="Second physicist name">
                        </div>
                        <div class="form-group">
                            <label>Review Date</label>
                            <input type="date" id="reviewDate">
                        </div>
                        <div class="form-group">
                            <label>Last Emergency Drill Date</label>
                            <input type="date" id="emergencyDrillDate">
                        </div>
                        <div class="form-group">
                            <label>Survey Meter ID</label>
                            <input type="text" id="surveyMeterID" placeholder="Calibrated survey meter">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Common Footer for all QA types -->
            <div class="form-group">
                <label>Additional Comments / Corrective Actions</label>
                <textarea id="qaComments" rows="4" placeholder="Any additional observations, issues identified, or corrective actions taken..."></textarea>
            </div>

            <div class="signature-section">
                <div class="signature-box">
                    <label>Performed By (Print Name)</label>
                    <p style="margin-top: 40px; font-size: 14px; color: var(--gray-500);">Signature: _______________________</p>
                    <p style="font-size: 14px; color: var(--gray-500);">Date: _______________________</p>
                </div>
                <div class="signature-box">
                    <label>Reviewed By (Medical Physicist)</label>
                    <p style="margin-top: 40px; font-size: 14px; color: var(--gray-500);">Signature: _______________________</p>
                    <p style="font-size: 14px; color: var(--gray-500);">Date: _______________________</p>
                </div>
            </div>

            <div class="button-group no-print">
                <button class="btn-success" onclick="saveQAReport()">üíæ Save Report</button>
                <button class="btn-primary" onclick="exportPDF()">üìÑ Export PDF</button>
                <button class="btn-secondary" onclick="printReport()">üñ®Ô∏è Print</button>
                <button class="btn-gray" onclick="resetQAForm()">Reset Form</button>
            </div>

            <div class="note">
                <strong>Reference:</strong> SASQART: South African standards for quality assurance in radiotherapy (2025)<br>
                <strong>Citation:</strong> Fourie H, Alidzulwi T, Boonzaier WPE, et al. S. Afr. j. oncol. 2025; 9(0), a329. https://doi.org/10.4102/sajo.v9i0.329<br>
                <strong>Note:</strong> Tests DBR1-8,11: Configuration depends on facility design. Safety is primary concern.<br>
                <strong>Note:</strong> DBR9/QBR5: Verify using autoradiographs, ion chamber measurements, or in-room cameras.
            </div>
        </div>

        <!-- HISTORY & REPORTS TAB -->
        <div id="history" class="main-tab-content">
            <div class="explanation">
                <h3>üìÅ QA History & Reports</h3>
                <p>View and manage your saved QA reports. All data is stored locally in your browser's IndexedDB.</p>
            </div>

            <div class="form-group">
                <label>Search Reports by Date Range</label>
                <div class="input-group">
                    <input type="date" id="historyStartDate">
                    <span style="padding: 12px;">to</span>
                    <input type="date" id="historyEndDate">
                    <button class="btn-secondary" onclick="searchReports()">Search</button>
                </div>
            </div>

            <div id="reportsList" style="margin-top: 20px;">
                <p style="text-align: center; color: var(--gray-500); padding: 40px;">
                    Select a date range and click Search to view saved reports.
                </p>
            </div>

            <div class="button-group no-print">
                <button class="btn-purple" onclick="exportAllReports()">üì§ Export All Reports (JSON)</button>
                <button class="btn-gray" onclick="clearOldReports()">üóëÔ∏è Clear Reports Older Than 1 Year</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // INLINE QA CALCULATORS
        // ============================================
        
        // Dwell time accuracy calculator (% difference)
        function calcDwellTime(prefix) {
            const setTime = parseFloat(document.getElementById(`${prefix}_set`).value);
            const measuredTime = parseFloat(document.getElementById(`${prefix}_measured`).value);
            const resultEl = document.getElementById(`${prefix}_result`);
            const statusEl = document.getElementById(`${prefix}_status`);
            const notesEl = document.getElementById(`${prefix}_notes`);
            
            if (setTime && measuredTime && setTime > 0) {
                const diff = ((measuredTime - setTime) / setTime) * 100;
                const absDiff = Math.abs(diff);
                resultEl.textContent = diff.toFixed(2) + '%';
                
                // Auto-set status based on tolerance
                if (absDiff <= 1) {
                    resultEl.style.color = 'var(--success)';
                    statusEl.value = 'pass';
                } else if (absDiff <= 2) {
                    resultEl.style.color = 'var(--warning)';
                    statusEl.value = 'pass';
                } else {
                    resultEl.style.color = 'var(--danger)';
                    statusEl.value = 'fail';
                }
                updateRowColor(statusEl);
                notesEl.value = `Set: ${setTime}s, Meas: ${measuredTime}s, Diff: ${diff.toFixed(2)}%`;
            } else {
                resultEl.textContent = '--%';
                resultEl.style.color = 'var(--secondary)';
            }
        }
        
        // Positional accuracy calculator (mm deviation)
        function calcPositional(prefix) {
            const expected = parseFloat(document.getElementById(`${prefix}_expected`).value);
            const measured = parseFloat(document.getElementById(`${prefix}_measured`).value);
            const resultEl = document.getElementById(`${prefix}_result`);
            const statusEl = document.getElementById(`${prefix}_status`);
            const notesEl = document.getElementById(`${prefix}_notes`);
            
            if (!isNaN(expected) && !isNaN(measured)) {
                const deviation = Math.abs(measured - expected);
                resultEl.textContent = deviation.toFixed(2) + ' mm';
                
                // Auto-set status based on tolerance (1mm tol, 2mm action)
                if (deviation <= 1) {
                    resultEl.style.color = 'var(--success)';
                    statusEl.value = 'pass';
                } else if (deviation <= 2) {
                    resultEl.style.color = 'var(--warning)';
                    statusEl.value = 'pass';
                } else {
                    resultEl.style.color = 'var(--danger)';
                    statusEl.value = 'fail';
                }
                updateRowColor(statusEl);
                notesEl.value = `Exp: ${expected}mm, Meas: ${measured}mm, Dev: ${deviation.toFixed(2)}mm`;
            } else {
                resultEl.textContent = '-- mm';
                resultEl.style.color = 'var(--secondary)';
            }
        }
        
        // Source strength calibration calculator (% difference)
        function calcSourceStrength(prefix) {
            const cert = parseFloat(document.getElementById(`${prefix}_cert`).value);
            const measured = parseFloat(document.getElementById(`${prefix}_measured`).value);
            const resultEl = document.getElementById(`${prefix}_result`);
            const statusEl = document.getElementById(`${prefix}_status`);
            const notesEl = document.getElementById(`${prefix}_notes`);
            
            if (cert && measured && cert > 0) {
                const diff = ((measured - cert) / cert) * 100;
                const absDiff = Math.abs(diff);
                resultEl.textContent = diff.toFixed(2) + '%';
                
                // Auto-set status based on tolerance (3% tol, 5% action)
                if (absDiff <= 3) {
                    resultEl.style.color = 'var(--success)';
                    statusEl.value = 'pass';
                } else if (absDiff <= 5) {
                    resultEl.style.color = 'var(--warning)';
                    statusEl.value = 'pass';
                } else {
                    resultEl.style.color = 'var(--danger)';
                    statusEl.value = 'fail';
                }
                updateRowColor(statusEl);
                notesEl.value = `Cert: ${cert}, Meas: ${measured}, Diff: ${diff.toFixed(2)}%`;
            } else {
                resultEl.textContent = '--%';
                resultEl.style.color = 'var(--secondary)';
            }
        }
        
        // Timer linearity calculator
        function calcLinearity() {
            const pairs = [];
            for (let i = 1; i <= 4; i++) {
                const set = parseFloat(document.getElementById(`qbr7_s${i}`).value);
                const measured = parseFloat(document.getElementById(`qbr7_m${i}`).value);
                if (set && measured && set > 0) {
                    pairs.push({ set, measured, diff: ((measured - set) / set) * 100 });
                }
            }
            
            const resultEl = document.getElementById('qbr7_result');
            const statusEl = document.getElementById('qbr7_status');
            const notesEl = document.getElementById('qbr7_notes');
            
            if (pairs.length >= 2) {
                const maxDiff = Math.max(...pairs.map(p => Math.abs(p.diff)));
                resultEl.textContent = maxDiff.toFixed(2) + '%';
                
                if (maxDiff <= 1) {
                    resultEl.style.color = 'var(--success)';
                    statusEl.value = 'pass';
                } else if (maxDiff <= 2) {
                    resultEl.style.color = 'var(--warning)';
                    statusEl.value = 'pass';
                } else {
                    resultEl.style.color = 'var(--danger)';
                    statusEl.value = 'fail';
                }
                updateRowColor(statusEl);
                notesEl.value = `Max deviation: ${maxDiff.toFixed(2)}% (${pairs.length} points)`;
            } else {
                resultEl.textContent = '--%';
                resultEl.style.color = 'var(--secondary)';
            }
        }
        
        // Transit dose reproducibility calculator
        function calcTransitDose() {
            const readings = [];
            for (let i = 1; i <= 3; i++) {
                const val = parseFloat(document.getElementById(`abr1_r${i}`).value);
                if (val) readings.push(val);
            }
            
            const resultEl = document.getElementById('abr1_result');
            const meanEl = document.getElementById('abr1_mean');
            const statusEl = document.getElementById('abr1_status');
            const notesEl = document.getElementById('abr1_notes');
            
            if (readings.length >= 2) {
                const mean = readings.reduce((a, b) => a + b, 0) / readings.length;
                const maxVar = Math.max(...readings.map(r => Math.abs((r - mean) / mean) * 100));
                
                meanEl.textContent = mean.toFixed(3);
                resultEl.textContent = maxVar.toFixed(2) + '%';
                
                if (maxVar <= 1) {
                    resultEl.style.color = 'var(--success)';
                    statusEl.value = 'pass';
                } else if (maxVar <= 2) {
                    resultEl.style.color = 'var(--warning)';
                    statusEl.value = 'pass';
                } else {
                    resultEl.style.color = 'var(--danger)';
                    statusEl.value = 'fail';
                }
                updateRowColor(statusEl);
                notesEl.value = `Mean: ${mean.toFixed(3)}, Max var: ${maxVar.toFixed(2)}%`;
            } else {
                meanEl.textContent = '--';
                resultEl.textContent = '--%';
                resultEl.style.color = 'var(--secondary)';
            }
        }
        
        // Quick decay calculator for DBR6 console source strength check
        function calcQuickDecay() {
            const initial = parseFloat(document.getElementById('dbr6_initial').value);
            const calDateStr = document.getElementById('dbr6_caldate').value;
            const console = parseFloat(document.getElementById('dbr6_console').value);
            
            const expectedEl = document.getElementById('dbr6_expected');
            const diffEl = document.getElementById('dbr6_diff');
            const statusEl = document.getElementById('dbr6_status');
            const notesEl = document.getElementById('dbr6_notes');
            
            if (initial && calDateStr) {
                const calDate = new Date(calDateStr);
                const today = new Date();
                const daysDiff = (today - calDate) / (1000 * 60 * 60 * 24);
                const halfLife = 73.83;
                const decayConstant = Math.LN2 / halfLife;
                const expected = initial * Math.exp(-decayConstant * daysDiff);
                
                expectedEl.textContent = expected.toFixed(3) + ' Ci';
                expectedEl.style.color = 'var(--primary)';
                
                if (console) {
                    const diff = ((console - expected) / expected) * 100;
                    const absDiff = Math.abs(diff);
                    diffEl.textContent = diff.toFixed(2) + '%';
                    
                    // Generally within 1% is excellent, 2% acceptable
                    if (absDiff <= 1) {
                        diffEl.style.color = 'var(--success)';
                        statusEl.value = 'pass';
                    } else if (absDiff <= 2) {
                        diffEl.style.color = 'var(--warning)';
                        statusEl.value = 'pass';
                    } else {
                        diffEl.style.color = 'var(--danger)';
                        statusEl.value = 'fail';
                    }
                    updateRowColor(statusEl);
                    notesEl.value = `Expected: ${expected.toFixed(3)} Ci, Console: ${console} Ci, Diff: ${diff.toFixed(2)}%`;
                } else {
                    diffEl.textContent = '--%';
                    diffEl.style.color = 'var(--secondary)';
                }
            } else {
                expectedEl.textContent = '-- Ci';
                expectedEl.style.color = 'var(--primary)';
                diffEl.textContent = '--%';
                diffEl.style.color = 'var(--secondary)';
            }
        }
        
        // Source replacement certificate vs measured calculator
        function calcSourceReplacement() {
            const cert = parseFloat(document.getElementById('certificateActivity').value);
            const measured = parseFloat(document.getElementById('measuredActivity').value);
            const diffEl = document.getElementById('srcRepl_diff');
            
            if (cert && measured && cert > 0) {
                const diff = ((measured - cert) / cert) * 100;
                const absDiff = Math.abs(diff);
                diffEl.textContent = diff.toFixed(2) + '%';
                
                if (absDiff <= 3) {
                    diffEl.style.color = 'var(--success)';
                } else if (absDiff <= 5) {
                    diffEl.style.color = 'var(--warning)';
                } else {
                    diffEl.style.color = 'var(--danger)';
                }
            } else {
                diffEl.textContent = '--%';
                diffEl.style.color = 'var(--secondary)';
            }
        }

        // ============================================
        // INDEXEDDB SETUP
        // ============================================
        let db;
        const DB_NAME = 'BrachytherapyQA_Complete';
        const DB_VERSION = 2;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => {
                    console.error('Database failed to open');
                    document.getElementById('dbStatus').textContent = 'DB Error';
                    document.getElementById('dbStatus').className = 'db-status error';
                    reject(request.error);
                };

                request.onsuccess = () => {
                    db = request.result;
                    console.log('Database opened successfully');
                    document.getElementById('dbStatus').textContent = 'DB Connected';
                    document.getElementById('dbStatus').className = 'db-status connected';
                    resolve(db);
                };

                request.onupgradeneeded = (e) => {
                    db = e.target.result;

                    if (!db.objectStoreNames.contains('decayData')) {
                        const decayStore = db.createObjectStore('decayData', { keyPath: 'id', autoIncrement: true });
                        decayStore.createIndex('savedAt', 'savedAt', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('qaReports')) {
                        const qaStore = db.createObjectStore('qaReports', { keyPath: 'id', autoIncrement: true });
                        qaStore.createIndex('date', 'date', { unique: false });
                        qaStore.createIndex('type', 'type', { unique: false });
                    }

                    if (!db.objectStoreNames.contains('timers')) {
                        const timerStore = db.createObjectStore('timers', { keyPath: 'id', autoIncrement: true });
                        timerStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
            });
        }

        // Database helper functions
        function saveToDb(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getFromDb(storeName, indexName, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const index = store.index(indexName);
                const request = index.getAll(value);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function getAllFromDb(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteFromDb(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // ============================================
        // DECAY CALCULATOR
        // ============================================
        const HALF_LIFE = 73.83;
        const DECAY_CONSTANT = Math.log(2) / HALF_LIFE;
        let decayChart = null;

        function calculateDecay() {
            const initialActivity = parseFloat(document.getElementById('initialActivity').value);
            const calibrationDate = document.getElementById('calibrationDate').value;
            const unit = document.getElementById('unit').value;

            if (!initialActivity || !calibrationDate) {
                document.getElementById('resultBox').classList.remove('show');
                document.getElementById('graphContainer').style.display = 'none';
                return;
            }

            const calDate = new Date(calibrationDate);
            const today = new Date();
            const daysElapsed = (today - calDate) / (1000 * 60 * 60 * 24);

            const currentActivity = initialActivity * Math.exp(-DECAY_CONSTANT * daysElapsed);
            const percentRemaining = (currentActivity / initialActivity) * 100;

            document.getElementById('currentActivity').textContent = currentActivity.toFixed(3) + ' ' + unit;
            document.getElementById('percentRemaining').textContent = percentRemaining.toFixed(2) + '% of initial activity';
            document.getElementById('daysElapsed').textContent = 'Days elapsed: ' + Math.floor(daysElapsed);

            document.getElementById('resultBox').classList.add('show');
            document.getElementById('recalibrateBtn').disabled = false;

            updateDecayGraph(initialActivity, unit);
        }

        function updateDecayGraph(initialActivity, unit) {
            const graphContainer = document.getElementById('graphContainer');
            graphContainer.style.display = 'block';

            const labels = [];
            const data = [];
            const calibrationDate = new Date(document.getElementById('calibrationDate').value);

            for (let day = 0; day <= 365; day += 5) {
                const date = new Date(calibrationDate);
                date.setDate(date.getDate() + day);
                labels.push(date.toLocaleDateString('en-ZA', { month: 'short', day: 'numeric' }));
                data.push(initialActivity * Math.exp(-DECAY_CONSTANT * day));
            }

            const ctx = document.getElementById('decayChart').getContext('2d');

            if (decayChart) {
                decayChart.destroy();
            }

            // Calculate half-life point (73.83 days)
            const halfLifeIndex = Math.round(HALF_LIFE / 5); // Index in our 5-day interval array
            const halfLifeDate = new Date(calibrationDate);
            halfLifeDate.setDate(halfLifeDate.getDate() + HALF_LIFE);
            const halfLifeActivity = initialActivity * 0.5;
            
            // Calculate source change date based on minimum activity threshold
            const minActivity = parseFloat(document.getElementById('minActivity').value);
            let sourceChangeIndex = null;
            let sourceChangeDate = null;
            let daysToSourceChange = null;
            
            if (minActivity && minActivity > 0 && minActivity < initialActivity) {
                // A = A0 * e^(-Œªt) ‚Üí t = -ln(A/A0) / Œª
                daysToSourceChange = -Math.log(minActivity / initialActivity) / DECAY_CONSTANT;
                sourceChangeIndex = Math.round(daysToSourceChange / 5);
                sourceChangeDate = new Date(calibrationDate);
                sourceChangeDate.setDate(sourceChangeDate.getDate() + daysToSourceChange);
            }

            // Build annotations
            const annotations = {
                halfLifeLine: {
                    type: 'line',
                    xMin: halfLifeIndex,
                    xMax: halfLifeIndex,
                    borderColor: '#3b82f6',
                    borderWidth: 2,
                    borderDash: [6, 4],
                    label: {
                        display: true,
                        content: `Half-life: ${halfLifeDate.toLocaleDateString('en-ZA', { month: 'short', day: 'numeric' })}`,
                        position: 'start',
                        backgroundColor: '#3b82f6',
                        color: 'white',
                        font: { size: 11, weight: 'bold' },
                        padding: 4
                    }
                },
                halfLifeHorizontal: {
                    type: 'line',
                    yMin: halfLifeActivity,
                    yMax: halfLifeActivity,
                    xMax: halfLifeIndex,
                    borderColor: '#3b82f6',
                    borderWidth: 1,
                    borderDash: [4, 4],
                    label: {
                        display: true,
                        content: `50%: ${halfLifeActivity.toFixed(2)} ${unit}`,
                        position: 'start',
                        backgroundColor: '#3b82f6',
                        color: 'white',
                        font: { size: 10 },
                        padding: 3
                    }
                }
            };
            
            // Add source change annotation if threshold is set
            if (sourceChangeIndex !== null && daysToSourceChange <= 365) {
                annotations.sourceChangeLine = {
                    type: 'line',
                    xMin: sourceChangeIndex,
                    xMax: sourceChangeIndex,
                    borderColor: '#dc2626',
                    borderWidth: 3,
                    borderDash: [8, 4],
                    label: {
                        display: true,
                        content: `Source Change: ${sourceChangeDate.toLocaleDateString('en-ZA', { month: 'short', day: 'numeric' })}`,
                        position: 'start',
                        backgroundColor: '#dc2626',
                        color: 'white',
                        font: { size: 11, weight: 'bold' },
                        padding: 4,
                        yAdjust: -20
                    }
                };
                annotations.sourceChangeHorizontal = {
                    type: 'line',
                    yMin: minActivity,
                    yMax: minActivity,
                    xMax: sourceChangeIndex,
                    borderColor: '#dc2626',
                    borderWidth: 1,
                    borderDash: [4, 4],
                    label: {
                        display: true,
                        content: `Min: ${minActivity.toFixed(2)} ${unit}`,
                        position: 'start',
                        backgroundColor: '#dc2626',
                        color: 'white',
                        font: { size: 10 },
                        padding: 3,
                        yAdjust: 0
                    }
                };
                
                // Update the info display with source change countdown
                const today = new Date();
                const daysUntilChange = Math.ceil((sourceChangeDate - today) / (1000 * 60 * 60 * 24));
                updateSourceChangeInfo(sourceChangeDate, daysUntilChange, minActivity, unit);
            } else {
                hideSourceChangeInfo();
            }

            decayChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Activity (${unit})`,
                        data: data,
                        borderColor: '#d97706',
                        backgroundColor: 'rgba(217, 119, 6, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        annotation: {
                            annotations: annotations
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                maxTicksLimit: 12
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: `Activity (${unit})`
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function updateSourceChangeInfo(date, daysUntil, minActivity, unit) {
            let infoEl = document.getElementById('sourceChangeInfo');
            if (!infoEl) {
                infoEl = document.createElement('div');
                infoEl.id = 'sourceChangeInfo';
                infoEl.className = 'info-box';
                document.getElementById('graphContainer').appendChild(infoEl);
            }
            
            let urgencyClass = '';
            let urgencyText = '';
            if (daysUntil <= 0) {
                urgencyClass = 'danger';
                urgencyText = '‚ö†Ô∏è SOURCE CHANGE OVERDUE';
            } else if (daysUntil <= 14) {
                urgencyClass = 'danger';
                urgencyText = 'üî¥ URGENT: Schedule source change now';
            } else if (daysUntil <= 30) {
                urgencyClass = 'warning';
                urgencyText = 'üü° Schedule source change soon';
            } else {
                urgencyClass = 'success';
                urgencyText = 'üü¢ Source within usable range';
            }
            
            infoEl.className = `info-box ${urgencyClass}`;
            infoEl.innerHTML = `
                <strong>Next Source Change:</strong> ${date.toLocaleDateString('en-ZA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                <br><strong>Days Remaining:</strong> ${daysUntil} days until activity drops below ${minActivity.toFixed(2)} ${unit}
                <br><strong>${urgencyText}</strong>
            `;
            infoEl.style.display = 'block';
        }
        
        function hideSourceChangeInfo() {
            const infoEl = document.getElementById('sourceChangeInfo');
            if (infoEl) infoEl.style.display = 'none';
        }

        function compareValues() {
            const currentActivityText = document.getElementById('currentActivity').textContent;
            const brachyValue = parseFloat(document.getElementById('brachyValue').value);

            if (!brachyValue) {
                alert('Please enter the TPS value');
                return;
            }

            const currentValue = parseFloat(currentActivityText);
            const difference = ((brachyValue - currentValue) / currentValue) * 100;

            document.getElementById('calcValue').textContent = currentValue.toFixed(3);
            document.getElementById('brachyValueDisplay').textContent = brachyValue.toFixed(3);
            document.getElementById('diffPercent').textContent = difference.toFixed(2);

            const comparisonBox = document.getElementById('comparisonBox');
            comparisonBox.classList.add('show');

            if (Math.abs(difference) <= 2) {
                comparisonBox.style.borderColor = '#059669';
                comparisonBox.style.background = '#d1fae5';
            } else if (Math.abs(difference) <= 3) {
                comparisonBox.style.borderColor = '#f59e0b';
                comparisonBox.style.background = '#fef3c7';
            } else {
                comparisonBox.style.borderColor = '#dc2626';
                comparisonBox.style.background = '#fee2e2';
            }
        }

        async function saveData() {
            const data = {
                initialActivity: document.getElementById('initialActivity').value,
                calibrationDate: document.getElementById('calibrationDate').value,
                unit: document.getElementById('unit').value,
                minActivity: document.getElementById('minActivity').value,
                savedAt: new Date().toISOString()
            };

            try {
                await saveToDb('decayData', data);
                document.getElementById('saveStatus').textContent = 'Saved!';
                setTimeout(() => {
                    document.getElementById('saveStatus').textContent = 'Ready';
                }, 2000);
            } catch (error) {
                console.error('Save failed:', error);
                document.getElementById('saveStatus').textContent = 'Save Failed';
            }
        }

        async function loadData() {
            try {
                const allData = await getAllFromDb('decayData');
                if (allData.length > 0) {
                    const latest = allData[allData.length - 1];
                    document.getElementById('initialActivity').value = latest.initialActivity || '';
                    document.getElementById('calibrationDate').value = latest.calibrationDate || '';
                    document.getElementById('unit').value = latest.unit || 'Ci';
                    document.getElementById('minActivity').value = latest.minActivity || '';
                    updateMinActivityUnit();
                    calculateDecay();
                }
            } catch (error) {
                console.error('Load failed:', error);
            }
        }
        
        function updateMinActivityUnit() {
            const unit = document.getElementById('unit').value;
            document.getElementById('minActivityUnit').textContent = unit;
        }

        function recalibrate() {
            const currentActivityText = document.getElementById('currentActivity').textContent;
            const currentValue = parseFloat(currentActivityText);

            if (currentValue) {
                document.getElementById('initialActivity').value = currentValue.toFixed(3);
                const today = new Date();
                document.getElementById('calibrationDate').value = today.toISOString().split('T')[0];
                calculateDecay();
                saveData();
            }
        }

        function resetAll() {
            if (confirm('Are you sure you want to reset all decay calculator data?')) {
                document.getElementById('initialActivity').value = '';
                document.getElementById('calibrationDate').value = '';
                document.getElementById('minActivity').value = '';
                document.getElementById('brachyValue').value = '';
                document.getElementById('resultBox').classList.remove('show');
                document.getElementById('comparisonBox').classList.remove('show');
                document.getElementById('graphContainer').style.display = 'none';
                document.getElementById('recalibrateBtn').disabled = true;
                hideSourceChangeInfo();
            }
        }

        // ============================================
        // TIMER FUNCTIONS
        // ============================================
        let timerSeconds = 0;
        let timerInterval = null;
        let timerRunning = false;

        function startTimer() {
            if (!timerRunning) {
                timerRunning = true;
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                }, 1000);
            }
        }

        function stopTimer() {
            timerRunning = false;
            clearInterval(timerInterval);
        }

        function resetTimer() {
            stopTimer();
            timerSeconds = 0;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timerSeconds / 3600);
            const minutes = Math.floor((timerSeconds % 3600) / 60);
            const seconds = timerSeconds % 60;

            document.getElementById('timerDisplay').textContent =
                String(hours).padStart(2, '0') + ':' +
                String(minutes).padStart(2, '0') + ':' +
                String(seconds).padStart(2, '0');
        }

        async function saveTimer() {
            if (timerSeconds === 0) {
                alert('Timer is at 00:00:00. Please start the timer first.');
                return;
            }

            const note = document.getElementById('timerNote').value || 'No note';
            const timerData = {
                time: timerSeconds,
                display: document.getElementById('timerDisplay').textContent,
                note: note,
                timestamp: new Date().toISOString()
            };

            try {
                await saveToDb('timers', timerData);
                document.getElementById('timerNote').value = '';
                resetTimer();
                loadTimers();
            } catch (error) {
                console.error('Timer save failed:', error);
                alert('Failed to save timer');
            }
        }

        async function loadTimers() {
            try {
                const timers = await getAllFromDb('timers');
                const timerList = document.getElementById('timerList');

                if (timers.length === 0) {
                    timerList.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 20px;">No saved timers yet</p>';
                    return;
                }

                timers.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                timerList.innerHTML = timers.slice(0, 10).map(timer => `
                    <div class="timer-item">
                        <div>
                            <strong style="font-family: 'JetBrains Mono', monospace;">${timer.display}</strong><br>
                            <small style="color: var(--gray-500);">${timer.note} | ${new Date(timer.timestamp).toLocaleString()}</small>
                        </div>
                        <button onclick="deleteTimer(${timer.id})">Delete</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Load timers failed:', error);
            }
        }

        async function deleteTimer(id) {
            try {
                await deleteFromDb('timers', id);
                loadTimers();
            } catch (error) {
                console.error('Delete timer failed:', error);
            }
        }

        // ============================================
        // QA REPORT FUNCTIONS
        // ============================================
        function setDefaultQADate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('qaDate').value = today;
        }

        function updateRowColor(selectElement) {
            const row = selectElement.closest('tr');
            const value = selectElement.value;

            row.classList.remove('status-pass', 'status-fail', 'status-na');
            if (value) {
                row.classList.add('status-' + value);
            }
        }

        function getActiveQAType() {
            if (document.getElementById('daily-qa').classList.contains('active')) return 'daily';
            if (document.getElementById('quarterly-qa').classList.contains('active')) return 'quarterly';
            if (document.getElementById('annual-qa').classList.contains('active')) return 'annual';
            return 'daily';
        }

        async function saveQAReport() {
            const qaType = getActiveQAType();
            
            const reportData = {
                date: document.getElementById('qaDate').value,
                performer: document.getElementById('qaPerformer').value,
                unit: document.getElementById('qaUnit').value,
                sourceActivity: document.getElementById('qaSourceActivity').value,
                comments: document.getElementById('qaComments').value,
                type: qaType,
                tests: [],
                savedAt: new Date().toISOString()
            };

            // Get tests from the active table
            let tableId = qaType + 'QATable';
            const rows = document.querySelectorAll(`#${tableId} tbody tr`);
            rows.forEach((row) => {
                const cells = row.querySelectorAll('td');
                reportData.tests.push({
                    testNumber: cells[0].textContent,
                    description: cells[1].textContent.split('\n')[0], // First line only
                    tolerance: cells[2].textContent,
                    status: cells[3].querySelector('select').value,
                    measurement: cells[4].querySelector('input').value
                });
            });

            // Add extra fields for quarterly/annual
            if (qaType === 'quarterly') {
                reportData.sourceDetails = {
                    newSourceSerial: document.getElementById('newSourceSerial')?.value || '',
                    certificateActivity: document.getElementById('certificateActivity')?.value || '',
                    measuredActivity: document.getElementById('measuredActivity')?.value || '',
                    chamberSerial: document.getElementById('chamberSerial')?.value || ''
                };
            }

            if (qaType === 'annual') {
                reportData.annualDetails = {
                    independentReviewer: document.getElementById('independentReviewer')?.value || '',
                    reviewDate: document.getElementById('reviewDate')?.value || '',
                    emergencyDrillDate: document.getElementById('emergencyDrillDate')?.value || '',
                    surveyMeterID: document.getElementById('surveyMeterID')?.value || ''
                };
            }

            try {
                await saveToDb('qaReports', reportData);
                alert(`${qaType.charAt(0).toUpperCase() + qaType.slice(1)} QA Report saved successfully!`);
            } catch (error) {
                console.error('QA save failed:', error);
                alert('Failed to save QA report');
            }
        }

        async function loadQAReport() {
            const date = document.getElementById('qaDate').value;
            const qaType = getActiveQAType();

            try {
                const reports = await getFromDb('qaReports', 'date', date);
                const matchingReports = reports.filter(r => r.type === qaType);

                if (matchingReports.length > 0) {
                    const data = matchingReports[matchingReports.length - 1];
                    document.getElementById('qaPerformer').value = data.performer || '';
                    document.getElementById('qaUnit').value = data.unit || '';
                    document.getElementById('qaSourceActivity').value = data.sourceActivity || '';
                    document.getElementById('qaComments').value = data.comments || '';

                    let tableId = qaType + 'QATable';
                    const rows = document.querySelectorAll(`#${tableId} tbody tr`);
                    rows.forEach((row, index) => {
                        if (data.tests[index]) {
                            const cells = row.querySelectorAll('td');
                            const select = cells[3].querySelector('select');
                            const input = cells[4].querySelector('input');

                            select.value = data.tests[index].status;
                            input.value = data.tests[index].measurement;
                            updateRowColor(select);
                        }
                    });

                    // Load extra fields
                    if (qaType === 'quarterly' && data.sourceDetails) {
                        document.getElementById('newSourceSerial').value = data.sourceDetails.newSourceSerial || '';
                        document.getElementById('certificateActivity').value = data.sourceDetails.certificateActivity || '';
                        document.getElementById('measuredActivity').value = data.sourceDetails.measuredActivity || '';
                        document.getElementById('chamberSerial').value = data.sourceDetails.chamberSerial || '';
                    }

                    if (qaType === 'annual' && data.annualDetails) {
                        document.getElementById('independentReviewer').value = data.annualDetails.independentReviewer || '';
                        document.getElementById('reviewDate').value = data.annualDetails.reviewDate || '';
                        document.getElementById('emergencyDrillDate').value = data.annualDetails.emergencyDrillDate || '';
                        document.getElementById('surveyMeterID').value = data.annualDetails.surveyMeterID || '';
                    }
                } else {
                    resetQAFormFields(false);
                }
            } catch (error) {
                console.error('Load QA failed:', error);
            }
        }

        function resetQAForm() {
            if (!confirm('Are you sure you want to reset the QA form?')) return;
            resetQAFormFields(true);
        }

        function resetQAFormFields(resetDate = true) {
            if (resetDate) setDefaultQADate();

            document.getElementById('qaPerformer').value = '';
            document.getElementById('qaUnit').value = '';
            document.getElementById('qaSourceActivity').value = '';
            document.getElementById('qaComments').value = '';

            // Reset all tables
            ['dailyQATable', 'quarterlyQATable', 'annualQATable'].forEach(tableId => {
                const selects = document.querySelectorAll(`#${tableId} .status-select`);
                const inputs = document.querySelectorAll(`#${tableId} .measurement-input`);

                selects.forEach(select => {
                    select.value = '';
                    updateRowColor(select);
                });

                inputs.forEach(input => input.value = '');
            });

            // Reset extra fields
            ['newSourceSerial', 'certificateActivity', 'measuredActivity', 'chamberSerial',
             'independentReviewer', 'reviewDate', 'emergencyDrillDate', 'surveyMeterID'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
        }

        function printReport() {
            // Get current QA type
            const activeTab = document.querySelector('.qa-type-tab.active');
            const qaType = activeTab ? activeTab.textContent.trim() : 'Daily';
            
            // Set print header info
            const reportTypeNames = {
                'daily': 'Daily QA Checklist (DBR1-DBR12)',
                'quarterly': 'Quarterly QA Checklist (QBR1-QBR8)',
                'annual': 'Annual QA Checklist (ABR1-ABR5)'
            };
            
            const currentType = document.querySelector('.qa-type-content.active')?.id?.replace('-qa', '') || 'daily';
            document.getElementById('printReportType').textContent = reportTypeNames[currentType] || 'QA Checklist';
            
            // Set current date/time
            const now = new Date();
            document.getElementById('printDate').textContent = 
                `Printed: ${now.toLocaleDateString('en-ZA')} ${now.toLocaleTimeString('en-ZA', {hour: '2-digit', minute: '2-digit'})}`;
            
            // Mark active QA type for printing
            document.querySelectorAll('.qa-type-content').forEach(el => {
                el.classList.remove('print-active');
            });
            document.querySelector('.qa-type-content.active')?.classList.add('print-active');
            
            // Trigger print
            window.print();
        }
        
        async function exportPDF() {
            const currentType = document.querySelector('.qa-type-content.active')?.id?.replace('-qa', '') || 'daily';
            const reportTypeNames = {
                'daily': 'Daily QA Checklist (DBR1-DBR12)',
                'quarterly': 'Quarterly QA Checklist (QBR1-QBR8)',
                'annual': 'Annual QA Checklist (ABR1-ABR5)'
            };
            
            // Get form data for filename
            const qaDate = document.getElementById('qaDate').value || new Date().toISOString().split('T')[0];
            const performer = document.getElementById('qaPerformer').value || 'Unknown';
            const filename = `Brachytherapy_${currentType.toUpperCase()}_QA_${qaDate}.pdf`;
            
            // Create a clone of the content for PDF generation
            const pdfContent = document.createElement('div');
            pdfContent.innerHTML = `
                <div style="font-family: 'IBM Plex Sans', Arial, sans-serif; padding: 20px;">
                    <div style="border-bottom: 3px solid #1e3a5f; padding-bottom: 15px; margin-bottom: 20px;">
                        <h1 style="color: #1e3a5f; margin: 0 0 10px 0; font-size: 20px;">Brachytherapy Quality Assurance</h1>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #444;">
                            <span><strong>${reportTypeNames[currentType]}</strong></span>
                            <span>Generated: ${new Date().toLocaleDateString('en-ZA')} ${new Date().toLocaleTimeString('en-ZA', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; font-size: 11px;">
                        <div><strong>Date:</strong> ${document.getElementById('qaDate').value || '-'}</div>
                        <div><strong>Performed By:</strong> ${document.getElementById('qaPerformer').value || '-'}</div>
                        <div><strong>Unit/Device:</strong> ${document.getElementById('qaUnit').value || '-'}</div>
                        <div><strong>Source Activity:</strong> ${document.getElementById('qaSourceActivity').value || '-'}</div>
                    </div>
                    
                    ${generatePDFTable(currentType)}
                    
                    <div style="margin-top: 20px; padding: 10px; background: #f9f9f9; border-radius: 5px; font-size: 11px;">
                        <strong>Comments/Corrective Actions:</strong><br>
                        ${document.getElementById('qaComments').value || 'None'}
                    </div>
                    
                    ${currentType === 'quarterly' ? generateQuarterlyFields() : ''}
                    ${currentType === 'annual' ? generateAnnualFields() : ''}
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 40px; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
                        <div style="text-align: center;">
                            <p style="font-weight: bold; margin-bottom: 40px;">Performed By</p>
                            <p style="border-top: 1px solid #333; padding-top: 5px; font-size: 11px;">Signature / Date</p>
                        </div>
                        <div style="text-align: center;">
                            <p style="font-weight: bold; margin-bottom: 40px;">Reviewed By (Medical Physicist)</p>
                            <p style="border-top: 1px solid #333; padding-top: 5px; font-size: 11px;">Signature / Date</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 10px; background: #f0f0f0; font-size: 9px; color: #666;">
                        <strong>Reference:</strong> SASQART 2025 - Fourie H, et al. S. Afr. j. oncol. 2025; 9(0), a329
                    </div>
                </div>
            `;
            
            // PDF options - A4 with proper margins
            const opt = {
                margin: [15, 12, 15, 12], // top, left, bottom, right in mm
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    letterRendering: true
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait'
                },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            
            // Show loading state
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Generating...';
            btn.disabled = true;
            
            try {
                await html2pdf().set(opt).from(pdfContent).save();
            } catch (error) {
                console.error('PDF generation failed:', error);
                alert('PDF generation failed. Please use the Print button instead.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function generatePDFTable(type) {
            const tableId = type + 'QATable';
            const table = document.getElementById(tableId);
            if (!table) return '';
            
            const rows = table.querySelectorAll('tbody tr');
            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 10px;">';
            html += '<thead><tr style="background: #1e3a5f; color: white;">';
            html += '<th style="padding: 8px 5px; text-align: left; width: 60px;">Test #</th>';
            html += '<th style="padding: 8px 5px; text-align: left;">Description</th>';
            html += '<th style="padding: 8px 5px; text-align: left; width: 90px;">Tolerance</th>';
            html += '<th style="padding: 8px 5px; text-align: left; width: 70px;">Status</th>';
            html += '<th style="padding: 8px 5px; text-align: left; width: 120px;">Notes</th>';
            html += '</tr></thead><tbody>';
            
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const bgColor = index % 2 === 0 ? '#fff' : '#f9f9f9';
                    const testId = cells[0].textContent.trim();
                    
                    // Get just the main description text, not the small helper text or calculators
                    let description = cells[1].childNodes[0]?.textContent?.trim() || cells[1].textContent.trim();
                    description = description.split('\n')[0]; // Get first line only
                    
                    const tolerance = cells[2].textContent.trim().replace(/\s+/g, ' ');
                    
                    const statusSelect = cells[3].querySelector('select');
                    let status = statusSelect?.value || '';
                    if (status === 'pass') status = '‚úì Pass';
                    else if (status === 'fail') status = '‚úó Fail';
                    else if (status === 'na') status = 'N/A';
                    else status = '-';
                    
                    const notesInput = cells[4].querySelector('input');
                    const notes = notesInput?.value || '';
                    
                    html += `<tr style="background: ${bgColor};">`;
                    html += `<td style="padding: 6px 5px; border-bottom: 1px solid #ddd; font-weight: bold;">${testId}</td>`;
                    html += `<td style="padding: 6px 5px; border-bottom: 1px solid #ddd;">${description}</td>`;
                    html += `<td style="padding: 6px 5px; border-bottom: 1px solid #ddd; font-size: 9px;">${tolerance}</td>`;
                    html += `<td style="padding: 6px 5px; border-bottom: 1px solid #ddd; font-weight: bold;">${status}</td>`;
                    html += `<td style="padding: 6px 5px; border-bottom: 1px solid #ddd; font-size: 9px;">${notes}</td>`;
                    html += '</tr>';
                }
            });
            
            html += '</tbody></table>';
            return html;
        }
        
        function generateQuarterlyFields() {
            const serial = document.getElementById('newSourceSerial')?.value || '-';
            const certAct = document.getElementById('certificateActivity')?.value || '-';
            const measAct = document.getElementById('measuredActivity')?.value || '-';
            const chamberSerial = document.getElementById('chamberSerial')?.value || '-';
            
            if (serial === '-' && certAct === '-' && measAct === '-') return '';
            
            return `
                <div style="margin-top: 20px; padding: 10px; background: #e8f4f8; border-radius: 5px; font-size: 11px;">
                    <strong>Source Replacement Details:</strong><br>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 8px;">
                        <div>Serial #: ${serial}</div>
                        <div>Certificate Activity: ${certAct}</div>
                        <div>Measured Activity: ${measAct}</div>
                        <div>Chamber ID: ${chamberSerial}</div>
                    </div>
                </div>
            `;
        }
        
        function generateAnnualFields() {
            const reviewer = document.getElementById('annualReviewer')?.value || '-';
            const drillDate = document.getElementById('emergencyDrillDate')?.value || '-';
            const surveyMeter = document.getElementById('surveyMeterSerial')?.value || '-';
            
            if (reviewer === '-' && drillDate === '-' && surveyMeter === '-') return '';
            
            return `
                <div style="margin-top: 20px; padding: 10px; background: #f3e8f8; border-radius: 5px; font-size: 11px;">
                    <strong>Annual Review Details:</strong><br>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 8px;">
                        <div>Independent Reviewer: ${reviewer}</div>
                        <div>Last Emergency Drill: ${drillDate}</div>
                        <div>Survey Meter ID: ${surveyMeter}</div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // HISTORY FUNCTIONS
        // ============================================
        async function searchReports() {
            const startDate = document.getElementById('historyStartDate').value;
            const endDate = document.getElementById('historyEndDate').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            try {
                const allReports = await getAllFromDb('qaReports');
                const filtered = allReports.filter(r => {
                    return r.date >= startDate && r.date <= endDate;
                }).sort((a, b) => new Date(b.date) - new Date(a.date));

                const reportsList = document.getElementById('reportsList');

                if (filtered.length === 0) {
                    reportsList.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 40px;">No reports found in the selected date range.</p>';
                    return;
                }

                reportsList.innerHTML = filtered.map(r => `
                    <div style="background: var(--gray-50); padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid ${r.type === 'daily' ? 'var(--success)' : r.type === 'quarterly' ? 'var(--secondary)' : 'var(--purple)'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${r.date}</strong> - 
                                <span class="frequency-badge ${r.type}">${r.type.toUpperCase()}</span>
                                <br>
                                <small style="color: var(--gray-500);">
                                    ${r.performer || 'Unknown'} | ${r.unit || 'Unknown unit'} | 
                                    ${r.tests.filter(t => t.status === 'pass').length}/${r.tests.length} passed
                                </small>
                            </div>
                            <button class="btn-outline" onclick="viewReport(${r.id})" style="flex: 0;">View</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Search failed:', error);
            }
        }

        async function exportAllReports() {
            try {
                const allReports = await getAllFromDb('qaReports');
                const blob = new Blob([JSON.stringify(allReports, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `brachytherapy-qa-reports-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export reports');
            }
        }

        function clearOldReports() {
            alert('This feature would clear reports older than 1 year. For safety, this is disabled in demo mode.');
        }

        // ============================================
        // TAB SWITCHING
        // ============================================
        function switchMainTab(tabName) {
            document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.main-tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function switchQAType(type) {
            document.querySelectorAll('.qa-type-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.qa-type-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(type + '-qa').classList.add('active');

            // Load data for new type
            loadQAReport();
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.onload = async function() {
            try {
                await initDB();
                await loadData();
                await loadTimers();
                setDefaultQADate();
                await loadQAReport();

                // Set default history dates
                const today = new Date();
                const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                document.getElementById('historyEndDate').value = today.toISOString().split('T')[0];
                document.getElementById('historyStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            } catch (error) {
                console.error('Initialization failed:', error);
                alert('Failed to initialize database. Some features may not work.');
            }
        };

        // Event listeners
        document.getElementById('initialActivity').addEventListener('input', calculateDecay);
        document.getElementById('calibrationDate').addEventListener('change', calculateDecay);
        document.getElementById('unit').addEventListener('change', calculateDecay);
        document.getElementById('qaDate').addEventListener('change', loadQAReport);

        // Auto-update decay calculation every minute
        setInterval(calculateDecay, 60000);
    </script>
</body>
</html>
